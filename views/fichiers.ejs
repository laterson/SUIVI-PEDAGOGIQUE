<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Documents partag√©s ‚Äî <%= (user && user.inspection ? user.inspection : '').toUpperCase() %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f7f7f9; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#0ea5e9; --card:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    main{max-width:1100px;margin:16px auto;padding:0 12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .drop{border:2px dashed var(--line);border-radius:10px;padding:16px;text-align:center;background:#fafbff}
    .drop.drag{background:#eef6ff;border-color:#93c5fd}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:6px 8px;font-size:12px;text-align:right;vertical-align:top}
    th:first-child,td:first-child{text-align:left}
    thead th{background:#f8fafc}
    .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:11px;color:#374151;background:#f9fafb}
    .filters{display:grid;grid-template-columns:1fr 1fr 120px auto auto;gap:8px}
    .input{border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:13px;width:100%}
  </style>
</head>
<body>
  <main>
    <h2>üìé Documents partag√©s ‚Äî <%= (user && user.inspection ? user.inspection : '').toUpperCase() %></h2>
    <div class="muted">Connect√© : <strong><%= user.nom %></strong> ‚Äî <%= (user.etab||'') %></div>

    <!-- Barre de filtres -->
    <div class="card">
      <div class="filters">
        <input id="fEtab" class="input" placeholder="Filtrer par √©tablissement‚Ä¶" />
        <input id="fDept" class="input" placeholder="Filtrer par d√©partement‚Ä¶" />
        <input id="fAnnee" class="input" placeholder="Ann√©e (ex: 2025-2026)" />
        <button id="btnFiltrer" class="btn">Filtrer</button>
        <button id="btnReset" class="btn">R√©initialiser</button>
      </div>
      <div class="muted" style="margin-top:6px">Astuce : vous pouvez taper un fragment d‚Äôintitul√© d‚Äô√©tablissement ou un code de d√©partement.</div>
    </div>

    <!-- Zone d‚Äôupload -->
    <div class="card">
      <div id="drop" class="drop">Glissez vos fichiers ici ou
        <button id="pick" class="btn" type="button">Parcourir‚Ä¶</button>
      </div>
      <input id="fileInput" type="file" multiple style="display:none" />
    </div>

    <!-- Liste -->
    <div class="card">
      <strong>Fichiers disponibles</strong>
      <div id="box" class="muted" style="margin-top:6px">Chargement‚Ä¶</div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <a
        href="<%= (typeof backUrl!=='undefined' && backUrl)
                ? backUrl
                : (user && user.role==='insp' ? '/inspector'
                   : (user && user.role==='admin' ? '/admin' : '/collecte/nouvelle')) %>"
        class="btn">‚Üê Retour au tableau de bord</a>
      <form action="/auth/logout" method="post" style="display:inline"><button class="btn">D√©connexion</button></form>
    </div>
  </main>

  <script>
    const esc=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    async function api(path,opts){ const r=await fetch(path,{credentials:'same-origin',...(opts||{})}); if(!r.ok) throw new Error('HTTP'); return r.json(); }

    const drop=document.getElementById('drop'), pick=document.getElementById('pick'), fileInput=document.getElementById('fileInput'), box=document.getElementById('box');

    // Filtres UI
    const fEtab=document.getElementById('fEtab');
    const fDept=document.getElementById('fDept');
    const fAnnee=document.getElementById('fAnnee');
    const btnFiltrer=document.getElementById('btnFiltrer');
    const btnReset=document.getElementById('btnReset');

    // Pr√©remplir depuis l‚ÄôURL si pr√©sente
    const params = new URLSearchParams(location.search);
    if(params.get('etablissement')) fEtab.value = params.get('etablissement');
    if(params.get('departement'))   fDept.value = params.get('departement');
    if(params.get('annee'))         fAnnee.value = params.get('annee');

    function buildQuery(){
      const q = new URLSearchParams();
      if(fEtab.value.trim()) q.set('etablissement', fEtab.value.trim());
      if(fDept.value.trim()) q.set('departement', fDept.value.trim());
      if(fAnnee.value.trim()) q.set('annee', fAnnee.value.trim());
      return q.toString();
    }

    btnFiltrer.addEventListener('click', ()=>{
      const qs = buildQuery();
      // maj URL (pour partage / rafra√Æchissement coh√©rent)
      const url = qs ? ('?'+qs) : location.pathname;
      history.replaceState(null,'', url);
      load();
    });
    btnReset.addEventListener('click', ()=>{
      fEtab.value = ''; fDept.value = ''; fAnnee.value = '';
      history.replaceState(null,'', location.pathname);
      load();
    });

    // Upload handlers
    pick.addEventListener('click',()=>fileInput.click());
    ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');}));
    ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
    drop.addEventListener('drop',e=> doUpload(e.dataTransfer.files));
    fileInput.addEventListener('change',e=> doUpload(e.target.files));

    async function doUpload(list){
      if(!list||!list.length) return;
      const fd=new FormData();
      [...list].forEach(f=> fd.append('files',f));
      try{
        await api('/fichiers/upload',{ method:'POST', body:fd });
        load(); // recharge la liste avec les filtres courants
      }catch(_){ alert('Upload √©chou√©'); }
    }

    function render(files){
      if(!files.length){ box.innerHTML='<div class="muted">Aucun fichier.</div>'; return; }
      const rows = files.map(f=>`
        <tr>
          <td>
            <a href="/fichiers/download/${encodeURIComponent(f.id)}" target="_blank" rel="noopener">${esc(f.name)}</a>
            <div class="muted" style="margin-top:2px">
              ${f.etablissement ? `<span class="tag">${esc(f.etablissement)}</span>` : ``}
              ${f.departement ? ` <span class="tag">Dept : ${esc(f.departement)}</span>` : ``}
              ${f.annee ? ` <span class="tag">Ann√©e : ${esc(f.annee)}</span>` : ``}
            </div>
          </td>
          <td>${Math.max(1, Math.round(f.size/1024))} Ko</td>
          <td>
            ${esc(f.ownerName || '')}
            ${f.ownerRole ? `<div class="muted">${esc(f.ownerRole)}</div>` : ``}
          </td>
          <td>${new Date(f.createdAt).toLocaleString()}</td>
          <td style="text-align:right">
            ${f.canDelete ? `
              <form action="/fichiers/${encodeURIComponent(f.id)}/delete" method="post" onsubmit="return confirm('Supprimer ?')">
                <button class="btn" type="submit">üóëÔ∏è Supprimer</button>
              </form>` : `<span class="muted">‚Äî</span>`}
          </td>
        </tr>
      `).join('');
      box.innerHTML = `<table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Taille</th>
            <th>Auteur</th>
            <th>Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    async function load(){
      try{
        const qs = buildQuery();
        const url = '/fichiers/list-all' + (qs ? ('?'+qs) : '');
        render(await api(url));
      }catch(_){
        box.textContent='Erreur.';
      }
    }
    load();
  </script>
</body>
</html>
